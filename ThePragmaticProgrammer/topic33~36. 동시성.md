# 6장. 동시성

# 서문. 동시성과 병렬성

- 동시성: 둘 이상의 코드 조각이 실행될 때 동시에 실행 중인 것처럼 행동하는 것 - 소프트웨어 동작 방식
- 병렬성: 실제로 동시에 실행되는 것 - 하드웨어가 하는 것

## 동시성을 얻으려면

- 실행 중에 코드의 다른 부분으로 실행을 전환할 수 있는 환경에서 코드를 구동해야 한다.
- 보통은 파이버나 스레드, 프로세스 등을 사용하여 동시성을 구현한다.

## 병렬성을 얻으려면

- 두 가지 일을 동시에 할 수 있는 하드웨어가 필요하다.
  - CPU 하나에 있는 여러 개의 코어일 수도 있고, 컴퓨터 한 대에 있는 여러 CPU이거나 아니면 네트워크로 연결된 여러 대의 컴퓨터일 수도 있다.

# topic 33. 시간적 결합 깨트리기

## 동시성 확보하기

시간이나 순서에 의존하는 시간적 결합을 끊는 방법을 생각해 내야 한다. <br />
그렇게 함으로써 유연성도 얻을 수 있고, 작업 흐름 분석과 아키텍처, 설계, 배포와 같은 개발의 여러 측면에서 시간과 관련된 의존성도 함께 줄일 수 있다. <br />
작업 흐름 분석으로 동시성을 개선하라.

# topic 34. 공유 상태는 틀린 상태

동시성이 있을 떄에, 두 코드가 동시에 실행되면 두 코드가 상태를 공유하는 경우가 생긴다. <br />

## 문제: 비원자적 갱신

두 코드가 같은 상태에서 동시에 실행하면 비원자적 갱신이 발생한다. 먼저 끝난 코드의 결과의 상태를 나중에 끝난 코드가 반영한 상태에서 실행한 것이 아니기 때문이다.

이것을 원자적으로 바꿔야 한다.

## 해결: 원자적 갱신

### 세마포어 및 다른 상호 배제 방법

자원의 공유를 막는 것이다.

**세마포어**

- 단순히 한 번에 한 코드만이 가질 수 있는 무언가다.
- 내용물을 바꾸고 싶은 코드는 세마포어를 소유하고 있을 때에만 바꿀 수 있다는 규칙을 도입하는 것이다.
- 먼저 세마포어를 확보한 쪽은 평소처럼 계속 실행되고, 세마포어를 얻지 못한 쪽은 세마포어를 얻을 수 있을 때까지 멈춰 있는다. 즉, 기다린다.

문제점: 모든 코드가 세마포어를 사용해야만 한다. 어떤 개발자가 약속을 지키지 않는 코드를 쓰면 다시 자원의 공유가 발생한다.

**상호 배제 (뮤텍스, Mutex)**

- 동시 프로그래밍에서 공유 불가능한 자원의 동시 사용을 피하기 위해 사용되는 알고리즘 (위키백과)

### 리소스를 트랜잭션으로 관리하라

- 제어를 중앙으로 집중시키자
- 이때도 세마포어가 사용된다.

# topic 35. 액터와 프로세스

## 액터

- 자신만의 비공개 지역 상태를 가진 독립 적인 가상 처리 장치
- 각 액터는 우편함을 하나씩 보유하고 있다
- 각 액터는 잠들고 있다가 우편함에 메시지가 도착하면 메시지를 처리한다. 그리고 다시 잠든다.
- 액터는 언제나 동시성을 띤다
- 액터를 관리하는 것이 하나도 없다.
- 시스템이 저장하는 상태는 오직 메시지와 각 액터의 지역 상태 뿐이다.
- 메시지는 수신자가 읽는 것 외에는 확인할 방법이 없다.
- 지역 상태는 액터 바깥에서는 접근이 불가능하다.
- 모든 메시지는 단방향이다. 답장이란 개념은 없다.
- 액터는 한 번에 하나의 메시지만 처리한다.

### 그 결과 액터 혹은 액터 모델은

- 공유 상태 없는 동시성을 가진다.
- 액터 모델은 공유된 상태가 없기 때문에 동시성을 다루는 코드를 쓸 필요가 없다.
- 기반 아키텍처에 대해 언급할 필요도 없다. 이렇게 구성된 컴포넌트들은 단일 프로세서든, 멀티 코어든, 여러 컴퓨터가 네트워크로 연결되어 있든 똑같이 잘 작동한다.

### Nact

Node.js용 액터 라이브러리

## 프로세스

- 운영 체제가 동시성을 지원하기 위하여 구현한다.

# topic 36. 칠판

### 메시징 시스템

- **카프카, NATS** 같은 메시징 시스템은 단순히 데이터를 보내는 것보다 훨씬 많은 일을 한다.
- 이벤트 로그의 형태로 영속성을 제공하고, 패턴 매칭 형태로 메시지를 가져오는 것도 지원한다.

# 결론: 동시성 문제 예방

아키텍처에서 액터와 메시징 시스템, 마이크로 서비스를 활용하면 애플리케이션에서 생길 수 있는 모든 종류의 동시성 문제를 예방할 수 있다.

하지만 간단하지는 않다.

- 이런 접근 방식을 사용하면 많은 동작이 간접적으로 일어나므로 분석이 더 힘들다.
  - 메시지 형식 및 API를 모아두는 중앙 저장소를 운영하면 도움이 될 것이다.
  - 이 저장소에서 코드나 문서까지 생성해 준다면 더욱 좋다.
- 시스템에서 처리하는 메시지나 정보를 추적할 수 있는 좋은 도구도 필요하다.
  - 유용한 기법: 특정한 비지니스 작업 처리를 시작할 때 고유한 '추적 아이디'를 만들어 붙이고, 해당 작업에 관여하는 모든 액터로 아이디를 전파하면, 나중에 로그 파일을 뒤져서 어떤 일이 일어났는지 재구성해 볼 수 있다.
- 이런 종류의 시스템은 맞춰야 하는 구성 요소 수가 더 많기 때문에 배포하고 관리하기 더 까다롭다.
  - 하지만 그 결과 시스템이 더 잘게 쪼개지고, 전체 시스템이 아니라 개별 액터만 교체하여 시스템을 업데이트할 수 있다는 면에서 어느 정도 보상 받는다.
